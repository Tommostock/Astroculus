<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒŒ Astroculus</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --void: #03020a;
    --deep: #07051a;
    --panel: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.08);
    --star: #ffffff;
    --nebula: #c084fc;
    --nebula2: #818cf8;
    --gold: #fbbf24;
    --mars: #f97316;
    --green: #34d399;
    --text: #e2e8f0;
    --muted: #64748b;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'Space Mono', monospace;
  }

  html { scroll-behavior: smooth; }

  body {
    background: var(--void);
    color: var(--text);
    font-family: var(--font-display);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ Starfield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #starfield {
    position: fixed; inset: 0; z-index: 0; pointer-events: none;
    background: radial-gradient(ellipse at 20% 20%, #0d0628 0%, transparent 60%),
                radial-gradient(ellipse at 80% 80%, #0a1628 0%, transparent 60%),
                var(--void);
  }
  .star {
    position: absolute; border-radius: 50%; background: white;
    animation: twinkle var(--d) ease-in-out infinite alternate;
    opacity: var(--o);
  }
  @keyframes twinkle { to { opacity: calc(var(--o) * 0.2); transform: scale(0.5); } }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page { position: relative; z-index: 1; }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    padding: 2rem 2rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(192,132,252,0.06) 0%, transparent 100%);
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;
  }
  .logo { display: flex; align-items: center; gap: 1rem; }
  .logo-icon {
    width: 48px; height: 48px; border-radius: 12px;
    background: linear-gradient(135deg, #7c3aed, #1e40af);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; flex-shrink: 0;
    box-shadow: 0 0 30px rgba(124,58,237,0.4);
  }
  .logo-text h1 { font-size: 1.3rem; font-weight: 800; letter-spacing: -0.02em; }
  .logo-text p { font-size: 0.75rem; color: var(--muted); font-family: var(--font-mono); margin-top: 2px; }

  .header-right { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
  .status-pill {
    display: flex; align-items: center; gap: 8px;
    background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.25);
    padding: 6px 14px; border-radius: 100px; font-size: 0.75rem;
    font-family: var(--font-mono); color: var(--green);
  }
  .pulse { width: 6px; height: 6px; border-radius: 50%; background: var(--green);
           animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity:1; box-shadow:0 0 0 0 rgba(52,211,153,0.4); }
                     50% { opacity:0.7; box-shadow:0 0 0 6px rgba(52,211,153,0); } }

  .btn {
    padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer;
    font-family: var(--font-display); font-weight: 700; font-size: 0.82rem;
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .btn-primary { background: linear-gradient(135deg, #7c3aed, #2563eb); color: white; }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(124,58,237,0.4); }
  .btn-primary:active { transform: none; }

  /* â”€â”€ Feed Control Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .feed-control {
    background: rgba(251,191,36,0.06); border-bottom: 1px solid rgba(251,191,36,0.15);
    padding: 12px 2rem; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .feed-status { display: flex; align-items: center; gap: 8px; }
  .feed-status .text { font-size: 0.75rem; font-family: var(--font-mono); color: var(--gold); }
  .feed-status .time { color: var(--muted); }
  .feed-status .countdown { color: var(--nebula); font-weight: 700; }

  /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  main { max-width: 800px; margin: 0 auto; padding: 2rem; }

  /* â”€â”€ Stat Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .stat-card {
    background: var(--panel); border: 1px solid var(--border); border-radius: 16px;
    padding: 1.25rem 1.5rem; position: relative; overflow: hidden;
    animation: fadeUp 0.5s ease both; animation-delay: var(--delay, 0s);
  }
  .stat-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background: var(--accent, linear-gradient(90deg, var(--nebula), var(--nebula2)));
  }
  @keyframes fadeUp { from { opacity:0; transform: translateY(16px); } to { opacity:1; transform: none; } }
  .stat-value { font-size: 2rem; font-weight: 800; color: var(--star); line-height: 1; }
  .stat-label { font-size: 0.72rem; color: var(--muted); font-family: var(--font-mono); margin-top: 6px; text-transform: uppercase; letter-spacing: 0.08em; }

  /* â”€â”€ Error / Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .error-box { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); border-radius: 12px; padding: 1rem 1.25rem; color: #fca5a5; font-size: 0.85rem; margin-bottom: 1.5rem; }
  .loader { text-align: center; padding: 4rem; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--nebula); border-radius: 50%; animation: spin 0.9s linear infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Feed Stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
  .feed-stream { display: flex; flex-direction: column; gap: 1.5rem; }
  .feed-card {
    background: var(--panel); border: 1px solid var(--border); border-radius: 16px;
    overflow: hidden; transition: transform 0.25s, border-color 0.25s, box-shadow 0.25s;
    cursor: pointer; animation: fadeUp 0.5s ease both; animation-delay: var(--d, 0s);
  }
  .feed-card:hover { transform: translateY(-2px); border-color: rgba(192,132,252,0.3); box-shadow: 0 16px 48px rgba(0,0,0,0.4); }

  .feed-image { width: 100%; max-height: 320px; object-fit: cover; display: block; background: linear-gradient(135deg,#1a0d3a,#0d1a38); }
  .feed-image-placeholder { width: 100%; height: 200px; background: linear-gradient(135deg,#1a0d3a,#0d1a38); display: flex; align-items: center; justify-content: center; font-size: 2rem; }

  .feed-card-body { padding: 1.25rem; }
  .feed-card-meta { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 0.75rem; }
  .feed-source { font-size: 0.65rem; font-family: var(--font-mono); color: var(--nebula); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; }
  .feed-date { font-size: 0.65rem; color: var(--muted); font-family: var(--font-mono); }
  .feed-category {
    font-size: 0.65rem; font-family: var(--font-mono);
    background: rgba(255,255,255,0.06); border: 1px solid var(--border);
    color: var(--muted); padding: 2px 8px; border-radius: 100px; white-space: nowrap;
  }

  .feed-title { font-size: 1rem; font-weight: 700; line-height: 1.4; margin-bottom: 0.5rem; color: var(--star); }
  .feed-description { font-size: 0.8rem; color: var(--muted); line-height: 1.6; margin-bottom: 0.75rem; }
  .feed-link { display: inline-flex; align-items: center; gap: 6px; font-size: 0.75rem; color: var(--nebula); text-decoration: none; font-family: var(--font-mono); transition: gap 0.2s; }
  .feed-link:hover { gap: 10px; }

  .empty-state { text-align: center; padding: 3rem; color: var(--muted); }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 1rem; }

  /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.85);
    backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center;
    padding: 1rem; opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: #0d0b1e; border: 1px solid var(--border); border-radius: 20px;
    max-width: 680px; width: 100%; max-height: 90vh; overflow-y: auto;
    transform: scale(0.95); transition: transform 0.3s;
  }
  .modal-overlay.open .modal { transform: scale(1); }
  .modal-img { width: 100%; max-height: 320px; object-fit: cover; border-radius: 16px 16px 0 0; }
  .modal-body { padding: 1.5rem; }
  .modal-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 0.75rem; }
  .modal-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 1rem; }
  .tag {
    background: rgba(255,255,255,0.06); border: 1px solid var(--border);
    color: var(--muted); font-size: 0.68rem; font-family: var(--font-mono);
    padding: 3px 10px; border-radius: 100px; white-space: nowrap;
  }
  .modal-description { font-size: 0.85rem; color: var(--muted); line-height: 1.75; }
  .modal-close { float: right; background: rgba(255,255,255,0.08); border: none; color: var(--text); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
  .modal-close:hover { background: rgba(255,255,255,0.15); }
  .modal-link { display: inline-flex; align-items: center; gap: 6px; margin-top: 1rem; color: var(--nebula); font-size: 0.82rem; text-decoration: none; }

  /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  footer { border-top: 1px solid var(--border); padding: 1.5rem 2rem; text-align: center; color: var(--muted); font-size: 0.75rem; font-family: var(--font-mono); }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 640px) {
    main { padding: 1rem; }
    header { padding: 1.5rem 1rem; }
    .feed-control { padding: 1rem; }
    .stat-value { font-size: 1.5rem; }
    .feed-title { font-size: 0.9rem; }
    .header-right { width: 100%; }
  }
</style>
</head>
<body>

<!-- Starfield -->
<div id="starfield"></div>

<div class="page">
  <!-- Header -->
  <header>
    <div class="logo">
      <div class="logo-icon">ğŸŒŒ</div>
      <div class="logo-text">
        <h1>Astroculus</h1>
        <p>Live Space Imagery Feed</p>
      </div>
    </div>
    <div class="header-right">
      <div class="status-pill">
        <div class="pulse"></div>
        <span>LIVE</span>
      </div>
      <button class="btn btn-primary" onclick="fetchAll()">ğŸ”„ Refresh Now</button>
    </div>
  </header>

  <!-- Feed Control Bar -->
  <div class="feed-control">
    <div class="feed-status">
      <span class="text">Last Updated:</span>
      <span class="time" id="last-updated">Never</span>
      <span style="margin-left: 1rem;">Next Check:</span>
      <span class="countdown" id="countdown">1h 0m</span>
    </div>
  </div>

  <main>
    <div id="error-area"></div>

    <!-- Stats Row -->
    <div class="stats-row">
      <div class="stat-card" style="--delay:0s; --accent: linear-gradient(90deg, #7c3aed, #4f46e5)">
        <div class="stat-value" id="stat-total">â€”</div>
        <div class="stat-label">Images in Feed</div>
      </div>
      <div class="stat-card" style="--delay:0.05s; --accent: linear-gradient(90deg, var(--gold), #f59e0b)">
        <div class="stat-value" id="stat-sources">â€”</div>
        <div class="stat-label">Sources Active</div>
      </div>
      <div class="stat-card" style="--delay:0.1s; --accent: linear-gradient(90deg, #10b981, #34d399)">
        <div class="stat-value" id="stat-date">â€”</div>
        <div class="stat-label">Today's Date</div>
      </div>
    </div>

    <!-- Feed Stream -->
    <div class="feed-stream" id="feed-stream">
      <div class="empty-state">
        <div class="icon">ğŸ”­</div>
        <p>Click "Refresh Now" to load the latest space imagery from NASA, SpaceX, Hubble, ESA, and more.</p>
      </div>
    </div>
  </main>

  <footer>Astroculus Â· Live Space Imagery Feed Â· NASA Â· SpaceX Â· Hubble Â· ESA Â· NOAA</footer>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<script>
/* â”€â”€ Starfield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function() {
  const sf = document.getElementById('starfield');
  for (let i = 0; i < 160; i++) {
    const s = document.createElement('div');
    const size = Math.random() < 0.8 ? 1 : Math.random() < 0.7 ? 2 : 3;
    const opacity = 0.1 + Math.random() * 0.7;
    s.className = 'star';
    s.style.cssText = `
      left:${Math.random()*100}%;top:${Math.random()*100}%;
      width:${size}px;height:${size}px;
      --o:${opacity};--d:${2+Math.random()*4}s;
      animation-delay:${Math.random()*5}s;
    `;
    sf.appendChild(s);
  }
})();

/* â”€â”€ Category Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CAT_COLORS = {
  'Nebula': '#c084fc', 'Galaxy': '#818cf8', 'Deep Field': '#60a5fa',
  'Black Hole': '#f43f5e', 'Star Cluster': '#fbbf24', 'Planet': '#34d399',
  'Solar Activity': '#f97316', 'Mars Surface': '#ef4444', 'Launch': '#2563eb', 'Other': '#64748b'
};

const CAT_RULES = [
  ['Mars Surface',['mars surface','curiosity','perseverance','sol ','jezero','rover','martian']],
  ['Nebula',['nebula','pillars','carina','orion','tarantula','stellar nursery','supernova remnant']],
  ['Galaxy',['galaxy','galaxies','milky way','andromeda','spiral','galactic','quasar']],
  ['Star Cluster',['star cluster','globular','open cluster','pleiades']],
  ['Planet',['planet','jupiter','saturn','venus','mercury','uranus','neptune','exoplanet']],
  ['Solar Activity',['solar','corona','flare','sunspot','aurora']],
  ['Black Hole',['black hole','event horizon','accretion']],
  ['Deep Field',['deep field','deep sky','ultra deep']],
  ['Launch',['spacex','launch','rocket','falcon','starship']],
];

function categorize(img) {
  const t = [img.title||'', img.description||'', img.source||''].join(' ').toLowerCase();
  for (const [cat, kws] of CAT_RULES) if (kws.some(k => t.includes(k))) return cat;
  return 'Other';
}

/* â”€â”€ Global State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let allImages = [];
let lastFetchTime = null;
let refreshInterval = null;
const CACHE_KEY = 'astroculus_feed_images';
const LAST_FETCH_KEY = 'astroculus_last_fetch';
const HOUR_MS = 3600000; // 1 hour

/* â”€â”€ LocalStorage Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function saveFeed(images) {
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify(images));
    const now = new Date().toISOString();
    localStorage.setItem(LAST_FETCH_KEY, now);
    lastFetchTime = now;
  } catch(e) {
    console.warn('Failed to save to localStorage:', e);
  }
}

function loadFeed() {
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    const lastFetch = localStorage.getItem(LAST_FETCH_KEY);
    if (cached) {
      lastFetchTime = lastFetch ? new Date(lastFetch) : null;
      return JSON.parse(cached);
    }
  } catch(e) {
    console.warn('Failed to load from localStorage:', e);
  }
  return [];
}

function clearOldImages(images, maxAgeHours = 24) {
  const cutoff = new Date(Date.now() - maxAgeHours * HOUR_MS);
  return images.filter(img => {
    if (!img.date) return true;
    try {
      const imgDate = new Date(img.date);
      return imgDate > cutoff;
    } catch {
      return true; // Keep if date parsing fails
    }
  });
}

/* â”€â”€ API Fetchers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
async function fetchAPOD() {
  try {
    const res = await fetch(`https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&count=8&thumbs=true`);
    if (!res.ok) throw new Error(`APOD error: ${res.status}`);
    const data = await res.json();
    return (Array.isArray(data) ? data : [data])
      .filter(d => d.media_type === 'image')
      .map(d => ({
        id: 'apod_' + d.date,
        source: 'NASA APOD',
        title: d.title || 'APOD Image',
        description: d.explanation || '',
        image_url: d.hdurl || d.url || '',
        date: d.date,
        url: `https://apod.nasa.gov/apod/ap${d.date.replace(/-/g,'').slice(2)}.html`
      }));
  } catch(e) {
    console.warn('APOD fetch failed:', e);
    return [];
  }
}

async function fetchSpaceX() {
  try {
    const res = await fetch('https://api.spacexdata.com/v4/launches/latest');
    if (!res.ok) throw new Error(`SpaceX error: ${res.status}`);
    const launch = await res.json();

    // Get the rocket info
    const rocketRes = await fetch(`https://api.spacexdata.com/v4/rockets/${launch.rocket}`);
    const rocket = rocketRes.ok ? await rocketRes.json() : { name: 'Unknown Rocket' };

    const images = [];
    if (launch.links?.flickr?.original?.length > 0) {
      launch.links.flickr.original.slice(0, 3).forEach((url, idx) => {
        images.push({
          id: `spacex_${launch.id}_${idx}`,
          source: 'SpaceX',
          title: launch.name || 'SpaceX Launch',
          description: `Rocket: ${rocket.name}. Mission Type: ${launch.mission_name || 'Unknown'}. Status: ${launch.success ? 'Success' : 'In Progress'}.`,
          image_url: url,
          date: launch.date_utc?.split('T')[0] || new Date().toISOString().split('T')[0],
          url: launch.links?.webcast || 'https://www.spacex.com'
        });
      });
    }

    if (images.length === 0 && launch.links?.webcast) {
      images.push({
        id: `spacex_${launch.id}`,
        source: 'SpaceX',
        title: launch.name || 'SpaceX Launch',
        description: `${rocket.name} launch. Mission: ${launch.mission_name || 'Unknown'}`,
        image_url: '',
        date: launch.date_utc?.split('T')[0] || new Date().toISOString().split('T')[0],
        url: launch.links.webcast
      });
    }

    return images;
  } catch(e) {
    console.warn('SpaceX fetch failed:', e);
    return [];
  }
}

async function fetchHubble() {
  try {
    const res = await fetch('https://images-api.nasa.gov/search?q=hubble&media_type=image&year_start=2024&page_size=10');
    if (!res.ok) throw new Error(`Hubble error: ${res.status}`);
    const data = await res.json();

    return (data.collection?.items || []).slice(0, 5).map(item => {
      const href = item.links?.[0]?.href || '';
      const data_obj = item.data?.[0] || {};
      return {
        id: `hubble_${data_obj.nasa_id || Math.random()}`,
        source: 'Hubble Space Telescope',
        title: data_obj.title || 'Hubble Image',
        description: data_obj.description || '',
        image_url: href,
        date: data_obj.date_created?.split('T')[0] || new Date().toISOString().split('T')[0],
        url: `https://images.nasa.gov/details-${data_obj.nasa_id}.html`
      };
    });
  } catch(e) {
    console.warn('Hubble fetch failed:', e);
    return [];
  }
}

async function fetchNOAA() {
  try {
    // NOAA Solar Dynamics Observatory recent images
    const res = await fetch('https://sdo.gsfc.nasa.gov/assets/img/latest/latest_1024_0193.jpg', { method: 'HEAD' });
    if (!res.ok) throw new Error(`NOAA error: ${res.status}`);

    return [{
      id: 'noaa_solar_' + Date.now(),
      source: 'NOAA / SDO',
      title: 'Solar Dynamics Observatory - Latest Image',
      description: 'Latest solar observation from NASA\'s Solar Dynamics Observatory (SDO).',
      image_url: 'https://sdo.gsfc.nasa.gov/assets/img/latest/latest_1024_0193.jpg',
      date: new Date().toISOString().split('T')[0],
      url: 'https://sdo.gsfc.nasa.gov/'
    }];
  } catch(e) {
    console.warn('NOAA fetch failed:', e);
    return [];
  }
}

async function fetchAll() {
  showError('');
  document.getElementById('feed-stream').innerHTML = '<div class="loader"><div class="spinner"></div><p style="color:var(--muted);font-size:0.85rem">Fetching latest images from all sourcesâ€¦</p></div>';

  try {
    const [apod, spacex, hubble, noaa] = await Promise.allSettled([
      fetchAPOD(),
      fetchSpaceX(),
      fetchHubble(),
      fetchNOAA(),
    ]);

    let images = [];
    if (apod.status === 'fulfilled') images.push(...apod.value);
    else console.warn('APOD failed:', apod.reason);

    if (spacex.status === 'fulfilled') images.push(...spacex.value);
    if (hubble.status === 'fulfilled') images.push(...hubble.value);
    if (noaa.status === 'fulfilled') images.push(...noaa.value);

    if (!images.length) throw new Error('No images fetched. Please try again later.');

    // Add category to each image
    images = images.map(img => {
      const category = categorize(img);
      return { ...img, category };
    });

    // Remove duplicates and sort by date (newest first)
    const uniqueIds = new Set();
    images = images.filter(img => {
      if (uniqueIds.has(img.id)) return false;
      uniqueIds.add(img.id);
      return true;
    }).sort((a, b) => {
      try {
        return new Date(b.date) - new Date(a.date);
      } catch {
        return 0;
      }
    });

    // Keep only last 100 images
    images = images.slice(0, 100);

    allImages = images;
    saveFeed(images);
    render(images);
  } catch(e) {
    showError(e.message || 'Failed to fetch images. Please try again.');
    console.error('Fetch error:', e);
    // Load cached images if available
    const cached = loadFeed();
    if (cached.length > 0) {
      allImages = cached;
      render(cached);
    }
  }
}

/* â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function render(images) {
  // Update stats
  const sources = [...new Set(images.map(i => i.source))];
  document.getElementById('stat-total').textContent = images.length;
  document.getElementById('stat-sources').textContent = sources.length;
  document.getElementById('stat-date').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

  // Update last-updated time
  updateTimestamps();

  // Render feed
  if (images.length === 0) {
    document.getElementById('feed-stream').innerHTML = '<div class="empty-state"><div class="icon">ğŸ”­</div><p>No images available. Try refreshing.</p></div>';
    return;
  }

  document.getElementById('feed-stream').innerHTML = images.map((img, i) => {
    const delay = (i * 0.05).toFixed(2);
    const truncDesc = (img.description || '').slice(0, 150);
    return `
      <div class="feed-card" style="--d:${delay}s" onclick="openModal(${i})">
        ${img.image_url
          ? `<img class="feed-image" src="${img.image_url}" alt="${escHtml(img.title)}" loading="lazy" onerror="this.style.display='none'">`
          : `<div class="feed-image-placeholder">ğŸ”­</div>`}
        <div class="feed-card-body">
          <div class="feed-card-meta">
            <span class="feed-source">${escHtml(img.source)}</span>
            <span class="feed-date">${img.date || 'â€”'}</span>
            <span class="feed-category">${img.category}</span>
          </div>
          <div class="feed-title">${escHtml(img.title)}</div>
          ${truncDesc ? `<div class="feed-description">${escHtml(truncDesc)}${img.description?.length > 150 ? 'â€¦' : ''}</div>` : ''}
          ${img.url ? `<a class="feed-link" href="${img.url}" target="_blank" onclick="event.stopPropagation()">View Source â†’</a>` : ''}
        </div>
      </div>`;
  }).join('');
}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function openModal(idx) {
  const img = allImages[idx];
  if (!img) return;

  document.getElementById('modal-body').innerHTML = `
    ${img.image_url ? `<img class="modal-img" src="${img.image_url}" alt="${escHtml(img.title)}" onerror="this.style.display='none'">` : ''}
    <div style="padding-top:${img.image_url ? '0' : '1.5rem'}">
      <button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">${escHtml(img.title)}</div>
      <div class="modal-meta">
        <span class="tag">${escHtml(img.source)}</span>
        <span class="tag">${img.category}</span>
        <span class="tag">${img.date || 'â€”'}</span>
      </div>
      <div class="modal-description">${escHtml(img.description || 'No description available.')}</div>
      ${img.url ? `<a class="modal-link" href="${img.url}" target="_blank">ğŸ”— View Source</a>` : ''}
    </div>`;

  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modal-overlay')) return;
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

/* â”€â”€ Timer & Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function updateTimestamps() {
  if (!lastFetchTime) {
    document.getElementById('last-updated').textContent = 'Never';
    document.getElementById('countdown').textContent = '1h 0m';
    return;
  }

  const now = new Date();
  const fetchDate = new Date(lastFetchTime);
  const diffMs = now - fetchDate;
  const diffMins = Math.floor(diffMs / 60000);

  if (diffMins < 1) {
    document.getElementById('last-updated').textContent = 'Just now';
  } else if (diffMins < 60) {
    document.getElementById('last-updated').textContent = `${diffMins}m ago`;
  } else {
    const diffHours = Math.floor(diffMins / 60);
    const remainingMins = diffMins % 60;
    document.getElementById('last-updated').textContent = `${diffHours}h ${remainingMins}m ago`;
  }

  // Countdown to next refresh (1 hour from fetch)
  const nextRefresh = new Date(fetchDate.getTime() + HOUR_MS);
  const countdownMs = nextRefresh - now;

  if (countdownMs <= 0) {
    document.getElementById('countdown').textContent = 'Now';
  } else {
    const countdownMins = Math.floor(countdownMs / 60000);
    const countdownHours = Math.floor(countdownMins / 60);
    const countdownRemaining = countdownMins % 60;
    document.getElementById('countdown').textContent = `${countdownHours}h ${countdownRemaining}m`;
  }
}

function startAutoRefresh() {
  // Update timestamps every minute
  setInterval(updateTimestamps, 60000);

  // Auto-refresh every hour
  refreshInterval = setInterval(() => {
    console.log('Auto-refreshing feed...');
    fetchAll();
  }, HOUR_MS);
}

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function showError(msg) {
  document.getElementById('error-area').innerHTML = msg
    ? `<div class="error-box">âš ï¸ ${escHtml(msg)}</div>` : '';
}

function escHtml(str) {
  return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

/* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
(function init() {
  // Load cached feed
  const cached = loadFeed();
  if (cached.length > 0) {
    allImages = cached;
    render(cached);
  }

  // Start auto-refresh timer
  startAutoRefresh();
})();
</script>
</body>
</html>
