<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒŒ Astroculus</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Merriweather:wght@400;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --void: #0a0810;
    --deep: #0f0c16;
    --panel: rgba(255,255,255,0.03);
    --border: rgba(255,255,255,0.06);
    --star: #e8e6f0;
    --accent-gold: #a8860f;
    --accent-blue: #4a7ba7;
    --accent-cyan: #3d9fbf;
    --text: #d9d6e6;
    --muted: #7a7a8f;
    --font-serif: 'Crimson Text', serif;
    --font-mono: 'IBM Plex Mono', monospace;
  }

  html { scroll-behavior: smooth; }

  body {
    background: var(--void);
    color: var(--text);
    font-family: var(--font-serif);
    font-size: 15px;
    line-height: 1.6;
    letter-spacing: 0.3px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ Starfield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #starfield {
    position: fixed; inset: 0; z-index: 0; pointer-events: none;
    background: radial-gradient(ellipse at 20% 20%, #1a1228 0%, transparent 60%),
                radial-gradient(ellipse at 80% 80%, #121830 0%, transparent 60%),
                var(--void);
  }
  .star {
    position: absolute; border-radius: 50%; background: #d9d6e6;
    animation: twinkle var(--d) ease-in-out infinite alternate;
    opacity: var(--o);
  }
  @keyframes twinkle { to { opacity: calc(var(--o) * 0.15); transform: scale(0.4); } }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page { position: relative; z-index: 1; }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    padding: 2.5rem 2.5rem 2rem;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(74,123,167,0.04) 0%, transparent 100%);
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 2rem;
  }
  .logo { display: flex; align-items: center; gap: 1.5rem; }
  .logo-icon {
    width: 56px; height: 56px; border-radius: 2px;
    background: linear-gradient(135deg, #3d9fbf, #4a7ba7);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem; flex-shrink: 0;
    box-shadow: inset 0 0 30px rgba(61,159,191,0.2), 0 0 20px rgba(61,159,191,0.15);
  }
  .logo-text h1 { font-size: 2rem; font-weight: 600; letter-spacing: 2px; font-style: italic; color: var(--star); }
  .logo-text p { font-size: 0.8rem; color: var(--muted); font-family: var(--font-mono); margin-top: 4px; letter-spacing: 1px; }

  .header-right { display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; }
  .status-pill {
    display: flex; align-items: center; gap: 8px;
    background: rgba(61,159,191,0.08); border: 1px solid rgba(61,159,191,0.2);
    padding: 7px 16px; border-radius: 2px; font-size: 0.75rem;
    font-family: var(--font-mono); color: var(--accent-cyan); letter-spacing: 1px; text-transform: uppercase;
  }
  .pulse { width: 5px; height: 5px; border-radius: 50%; background: var(--accent-cyan);
           animation: pulse 2.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity:1; box-shadow:0 0 0 0 rgba(61,159,191,0.4); }
                     50% { opacity:0.6; box-shadow:0 0 0 8px rgba(61,159,191,0); } }

  .btn {
    padding: 10px 24px; border-radius: 2px; border: 1px solid var(--border); cursor: pointer;
    font-family: var(--font-mono); font-weight: 500; font-size: 0.75rem;
    transition: all 0.25s; display: flex; align-items: center; gap: 8px;
    letter-spacing: 0.5px; text-transform: uppercase; background: rgba(61,159,191,0.08);
  }
  .btn-primary { background: rgba(61,159,191,0.12); border-color: rgba(61,159,191,0.25); color: var(--accent-cyan); }
  .btn-primary:hover { background: rgba(61,159,191,0.18); border-color: rgba(61,159,191,0.35); box-shadow: 0 0 20px rgba(61,159,191,0.15); }
  .btn-primary:active { transform: none; }

  /* â”€â”€ Feed Control Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .feed-control {
    background: rgba(168,134,15,0.05); border-bottom: 1px solid rgba(168,134,15,0.12);
    padding: 14px 2.5rem; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
  }
  .feed-status { display: flex; align-items: center; gap: 12px; }
  .feed-status .text { font-size: 0.7rem; font-family: var(--font-mono); color: var(--accent-gold); text-transform: uppercase; letter-spacing: 0.5px; }
  .feed-status .time { color: var(--text); font-weight: 500; }
  .feed-status .countdown { color: var(--accent-cyan); font-weight: 500; font-family: var(--font-mono); }

  /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  main { max-width: 900px; margin: 0 auto; padding: 3rem 2.5rem; }

  /* â”€â”€ Live Streams Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .live-streams-section { margin-bottom: 4rem; }
  .live-streams-header { font-size: 0.65rem; font-family: var(--font-mono); color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; }
  .live-streams-header::before { content: 'â—'; color: #e74c3c; font-size: 0.8rem; animation: livePulse 2s infinite; }
  @keyframes livePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
  .live-stream-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; }
  .live-stream-card { background: var(--panel); border: 1px solid var(--border); border-radius: 0; overflow: hidden; transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s; animation: fadeUp 0.5s ease both; animation-delay: var(--d, 0s); }
  .live-stream-card:hover { transform: translateY(-3px); border-color: rgba(61,159,191,0.25); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }

  .stream-player { width: 100%; aspect-ratio: 16 / 9; background: linear-gradient(135deg,#1a1828,#0f1524); overflow: hidden; }
  .stream-player video, .stream-player iframe { width: 100%; height: 100%; border: none; }

  .stream-meta { padding: 1.5rem; }
  .stream-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 0.6rem; font-family: var(--font-mono); color: #e74c3c; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 0.75rem; }
  .stream-badge::before { content: 'â—'; font-size: 0.8rem; }
  .stream-meta h3 { font-size: 1.1rem; font-weight: 600; color: var(--star); margin-bottom: 0.5rem; font-family: var(--font-serif); }
  .stream-agency { font-size: 0.6rem; font-family: var(--font-mono); color: var(--accent-gold); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem; }
  .stream-desc { font-size: 0.8rem; color: var(--muted); line-height: 1.6; }

  /* â”€â”€ Stat Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; margin-bottom: 3rem; }
  .stat-card {
    background: var(--panel); border: 1px solid var(--border); border-radius: 0;
    padding: 1.75rem 2rem; position: relative; overflow: hidden;
    animation: fadeUp 0.5s ease both; animation-delay: var(--delay, 0s);
  }
  .stat-card::before {
    content:''; position:absolute; bottom:0; left:0; right:0; height:2px;
    background: var(--accent, linear-gradient(90deg, var(--accent-cyan), var(--accent-blue)));
  }
  @keyframes fadeUp { from { opacity:0; transform: translateY(16px); } to { opacity:1; transform: none; } }
  .stat-value { font-size: 2.2rem; font-weight: 600; color: var(--star); line-height: 1; font-family: var(--font-mono); }
  .stat-label { font-size: 0.65rem; color: var(--muted); font-family: var(--font-mono); margin-top: 12px; text-transform: uppercase; letter-spacing: 1px; }

  /* â”€â”€ Error / Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .error-box { background: rgba(200,80,80,0.08); border: 1px solid rgba(200,80,80,0.2); border-radius: 0; padding: 1.25rem 1.5rem; color: #d9a5a5; font-size: 0.8rem; margin-bottom: 1.5rem; line-height: 1.6; }
  .loader { text-align: center; padding: 4rem 2rem; }
  .spinner { width: 40px; height: 40px; border: 2px solid var(--border); border-top-color: var(--accent-cyan); border-radius: 0; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Feed Stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
  .feed-stream { display: flex; flex-direction: column; gap: 2.5rem; }
  .feed-card {
    background: var(--panel); border: 1px solid var(--border); border-radius: 0;
    overflow: hidden; transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s;
    cursor: pointer; animation: fadeUp 0.5s ease both; animation-delay: var(--d, 0s);
  }
  .feed-card:hover { transform: translateY(-3px); border-color: rgba(61,159,191,0.25); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }

  .feed-image { width: 100%; max-height: 400px; object-fit: cover; display: block; background: linear-gradient(135deg,#1a1828,#0f1524); }
  .feed-image-placeholder { width: 100%; height: 240px; background: linear-gradient(135deg,#1a1828,#0f1524); display: flex; align-items: center; justify-content: center; font-size: 3rem; }

  .feed-card-body { padding: 2rem; }
  .feed-card-meta { display: flex; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 1rem; }
  .feed-source { font-size: 0.6rem; font-family: var(--font-mono); color: var(--accent-gold); text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }
  .feed-date { font-size: 0.6rem; color: var(--muted); font-family: var(--font-mono); letter-spacing: 0.5px; }
  .feed-category {
    font-size: 0.6rem; font-family: var(--font-mono);
    background: rgba(61,159,191,0.1); border: 1px solid rgba(61,159,191,0.2);
    color: var(--accent-cyan); padding: 3px 10px; border-radius: 0; white-space: nowrap;
    text-transform: uppercase; letter-spacing: 0.5px;
  }

  .feed-title { font-size: 1.3rem; font-weight: 600; line-height: 1.5; margin-bottom: 0.75rem; color: var(--star); font-family: var(--font-serif); }
  .feed-description { font-size: 0.85rem; color: var(--muted); line-height: 1.7; margin-bottom: 1rem; }
  .feed-link { display: inline-flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--accent-cyan); text-decoration: none; font-family: var(--font-mono); transition: gap 0.3s; letter-spacing: 0.5px; text-transform: uppercase; }
  .feed-link:hover { gap: 12px; }

  .empty-state { text-align: center; padding: 4rem 3rem; color: var(--muted); }
  .empty-state .icon { font-size: 3rem; margin-bottom: 1.5rem; }
  .empty-state p { font-size: 0.95rem; line-height: 1.8; }

  /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.9);
    backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center;
    padding: 1.5rem; opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: #0f0c16; border: 1px solid var(--border); border-radius: 0;
    max-width: 720px; width: 100%; max-height: 90vh; overflow-y: auto;
    transform: scale(0.95); transition: transform 0.3s;
    box-shadow: 0 25px 60px rgba(0,0,0,0.7);
  }
  .modal-overlay.open .modal { transform: scale(1); }
  .modal-img { width: 100%; max-height: 400px; object-fit: cover; border-radius: 0; }
  .modal-body { padding: 2.5rem; }
  .modal-title { font-size: 1.6rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--star); font-family: var(--font-serif); }
  .modal-meta { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; }
  .tag {
    background: rgba(61,159,191,0.1); border: 1px solid rgba(61,159,191,0.2);
    color: var(--accent-cyan); font-size: 0.6rem; font-family: var(--font-mono);
    padding: 5px 12px; border-radius: 0; white-space: nowrap;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .modal-description { font-size: 0.9rem; color: var(--text); line-height: 1.8; }
  .modal-close { float: right; background: rgba(61,159,191,0.1); border: 1px solid rgba(61,159,191,0.2); color: var(--accent-cyan); width: 36px; height: 36px; border-radius: 0; cursor: pointer; font-size: 1.2rem; transition: all 0.2s; }
  .modal-close:hover { background: rgba(61,159,191,0.15); border-color: rgba(61,159,191,0.35); }
  .modal-link { display: inline-flex; align-items: center; gap: 8px; margin-top: 1.5rem; color: var(--accent-cyan); font-size: 0.7rem; text-decoration: none; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.5px; }

  /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  footer { border-top: 1px solid var(--border); padding: 2rem 2.5rem; text-align: center; color: var(--muted); font-size: 0.7rem; font-family: var(--font-mono); letter-spacing: 0.5px; text-transform: uppercase; }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 1024px) {
    .live-stream-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 640px) {
    main { padding: 1rem; }
    header { padding: 1.5rem 1rem; }
    .feed-control { padding: 1rem; }
    .stat-value { font-size: 1.5rem; }
    .feed-title { font-size: 0.9rem; }
    .header-right { width: 100%; }
    .live-stream-grid { grid-template-columns: 1fr; }
    .stream-player { aspect-ratio: 16 / 9; }
  }
</style>
</head>
<body>

<!-- Starfield -->
<div id="starfield"></div>

<div class="page">
  <!-- Header -->
  <header>
    <div class="logo">
      <div class="logo-icon">ğŸŒŒ</div>
      <div class="logo-text">
        <h1>Astroculus</h1>
        <p>Live Space Imagery Feed</p>
      </div>
    </div>
    <div class="header-right">
      <div class="status-pill">
        <div class="pulse"></div>
        <span>LIVE</span>
      </div>
      <button class="btn btn-primary" onclick="fetchAll()">ğŸ”„ Refresh Now</button>
    </div>
  </header>

  <!-- Feed Control Bar -->
  <div class="feed-control">
    <div class="feed-status">
      <span class="text">Last Updated:</span>
      <span class="time" id="last-updated">Never</span>
      <span style="margin-left: 1rem;">Next Check:</span>
      <span class="countdown" id="countdown">1h 0m</span>
    </div>
  </div>

  <main>
    <div id="error-area"></div>

    <!-- Live Streams Section -->
    <div class="live-streams-section" id="live-streams-section">
      <div class="live-streams-header">Live Streams</div>
      <div class="live-stream-grid" id="live-stream-grid"></div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
      <div class="stat-card" style="--delay:0s; --accent: linear-gradient(90deg, #7c3aed, #4f46e5)">
        <div class="stat-value" id="stat-total">â€”</div>
        <div class="stat-label">Images in Feed</div>
      </div>
      <div class="stat-card" style="--delay:0.05s; --accent: linear-gradient(90deg, var(--gold), #f59e0b)">
        <div class="stat-value" id="stat-sources">â€”</div>
        <div class="stat-label">Sources Active</div>
      </div>
      <div class="stat-card" style="--delay:0.1s; --accent: linear-gradient(90deg, #10b981, #34d399)">
        <div class="stat-value" id="stat-date">â€”</div>
        <div class="stat-label">Today's Date</div>
      </div>
    </div>

    <!-- Feed Stream -->
    <div class="feed-stream" id="feed-stream">
      <div class="empty-state">
        <div class="icon">ğŸ”­</div>
        <p>Click "Refresh Now" to load the latest space imagery from NASA, SpaceX, Hubble, ESA, and more.</p>
      </div>
    </div>
  </main>

  <footer>Astroculus Â· Live Space Imagery Feed Â· NASA Â· SpaceX Â· Hubble Â· ESA Â· NOAA</footer>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<script>
/* â”€â”€ Starfield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function() {
  const sf = document.getElementById('starfield');
  for (let i = 0; i < 160; i++) {
    const s = document.createElement('div');
    const size = Math.random() < 0.8 ? 1 : Math.random() < 0.7 ? 2 : 3;
    const opacity = 0.1 + Math.random() * 0.7;
    s.className = 'star';
    s.style.cssText = `
      left:${Math.random()*100}%;top:${Math.random()*100}%;
      width:${size}px;height:${size}px;
      --o:${opacity};--d:${2+Math.random()*4}s;
      animation-delay:${Math.random()*5}s;
    `;
    sf.appendChild(s);
  }
})();

/* â”€â”€ Category Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CAT_COLORS = {
  'Nebula': '#7ba8c4', 'Galaxy': '#5a9bc5', 'Deep Field': '#4a9dc7',
  'Black Hole': '#b87c7c', 'Star Cluster': '#a8a860', 'Planet': '#6cb8a0',
  'Solar Activity': '#c48a5c', 'Mars Surface': '#b87878', 'Launch': '#5a9bc5', 'Other': '#6a7a8a'
};

const CAT_RULES = [
  ['Mars Surface',['mars surface','curiosity','perseverance','sol ','jezero','rover','martian']],
  ['Nebula',['nebula','pillars','carina','orion','tarantula','stellar nursery','supernova remnant']],
  ['Galaxy',['galaxy','galaxies','milky way','andromeda','spiral','galactic','quasar']],
  ['Star Cluster',['star cluster','globular','open cluster','pleiades']],
  ['Planet',['planet','jupiter','saturn','venus','mercury','uranus','neptune','exoplanet']],
  ['Solar Activity',['solar','corona','flare','sunspot','aurora']],
  ['Black Hole',['black hole','event horizon','accretion']],
  ['Deep Field',['deep field','deep sky','ultra deep']],
  ['Launch',['spacex','launch','rocket','falcon','starship']],
];

function categorize(img) {
  const t = [img.title||'', img.description||'', img.source||''].join(' ').toLowerCase();
  for (const [cat, kws] of CAT_RULES) if (kws.some(k => t.includes(k))) return cat;
  return 'Other';
}

/* â”€â”€ Global State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let allImages = [];
let lastFetchTime = null;
let refreshInterval = null;
const CACHE_KEY = 'astroculus_feed_images';
const LAST_FETCH_KEY = 'astroculus_last_fetch';
const HOUR_MS = 3600000; // 1 hour

/* â”€â”€ LocalStorage Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function saveFeed(images) {
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify(images));
    const now = new Date().toISOString();
    localStorage.setItem(LAST_FETCH_KEY, now);
    lastFetchTime = now;
  } catch(e) {
    console.warn('Failed to save to localStorage:', e);
  }
}

function loadFeed() {
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    const lastFetch = localStorage.getItem(LAST_FETCH_KEY);
    if (cached) {
      lastFetchTime = lastFetch ? new Date(lastFetch) : null;
      return JSON.parse(cached);
    }
  } catch(e) {
    console.warn('Failed to load from localStorage:', e);
  }
  return [];
}

function clearOldImages(images, maxAgeHours = 24) {
  const cutoff = new Date(Date.now() - maxAgeHours * HOUR_MS);
  return images.filter(img => {
    if (!img.date) return true;
    try {
      const imgDate = new Date(img.date);
      return imgDate > cutoff;
    } catch {
      return true; // Keep if date parsing fails
    }
  });
}

/* â”€â”€ Live Stream Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
async function initLiveStreams() {
  const streams = [
    {
      id: 'nasa_iss_earth',
      agency: 'NASA',
      title: 'ISS Earth View',
      type: 'persistent',
      embedType: 'hls',
      streamUrl: 'https://d2ai41bknpka2u.cloudfront.net/live/iss.stream_source/chunklist.m3u8',
      isLive: true,
      description: '24/7 HD camera feed from the International Space Station'
    },
    {
      id: 'nasa_tv_public',
      agency: 'NASA',
      title: 'NASA TV Public',
      type: 'persistent',
      embedType: 'hls',
      streamUrl: 'https://nasa-i.akamaihd.net/hls/live/253565/NASA-NTV1-Public/master.m3u8',
      isLive: true,
      description: '24/7 Educational programming and live mission coverage'
    },
    {
      id: 'esa_webtv',
      agency: 'ESA',
      title: 'ESA Web TV',
      type: 'persistent',
      embedType: 'iframe',
      streamUrl: 'https://watch.esa.int/',
      isLive: true,
      description: 'European Space Agency 24/7 live stream'
    }
  ];

  return streams;
}

function renderLiveStreams(streams) {
  const grid = document.getElementById('live-stream-grid');
  if (!grid) return;

  grid.innerHTML = streams.map((stream, idx) => {
    const delay = (idx * 0.1).toFixed(2);
    const playerHtml = stream.embedType === 'hls'
      ? `<video controls style="width:100%;height:100%;object-fit:contain;background:#000">
           <source src="${stream.streamUrl}" type="application/x-mpegURL">
           Your browser does not support HLS video playback
         </video>`
      : `<iframe src="${stream.streamUrl}" style="width:100%;height:100%;border:none;" allow="autoplay; fullscreen" allowfullscreen></iframe>`;

    return `
      <div class="live-stream-card" style="--d:${delay}s">
        <div class="stream-player">
          ${playerHtml}
        </div>
        <div class="stream-meta">
          <div class="stream-badge">${stream.isLive ? 'LIVE' : 'ON DEMAND'}</div>
          <h3>${stream.title}</h3>
          <p class="stream-agency">${stream.agency}</p>
          <p class="stream-desc">${stream.description}</p>
        </div>
      </div>`;
  }).join('');
}

/* â”€â”€ API Fetchers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
async function fetchAPOD() {
  try {
    const res = await fetch(`https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&count=8&thumbs=true`);
    if (!res.ok) throw new Error(`APOD error: ${res.status}`);
    const data = await res.json();
    return (Array.isArray(data) ? data : [data])
      .filter(d => d.media_type === 'image')
      .map(d => ({
        id: 'apod_' + d.date,
        source: 'NASA APOD',
        title: d.title || 'APOD Image',
        description: d.explanation || '',
        image_url: d.hdurl || d.url || '',
        date: d.date,
        url: `https://apod.nasa.gov/apod/ap${d.date.replace(/-/g,'').slice(2)}.html`
      }));
  } catch(e) {
    console.warn('APOD fetch failed:', e);
    return [];
  }
}

async function fetchSpaceX() {
  try {
    const res = await fetch('https://api.spacexdata.com/v4/launches/latest');
    if (!res.ok) throw new Error(`SpaceX error: ${res.status}`);
    const launch = await res.json();

    // Get the rocket info
    const rocketRes = await fetch(`https://api.spacexdata.com/v4/rockets/${launch.rocket}`);
    const rocket = rocketRes.ok ? await rocketRes.json() : { name: 'Unknown Rocket' };

    const images = [];
    if (launch.links?.flickr?.original?.length > 0) {
      launch.links.flickr.original.slice(0, 3).forEach((url, idx) => {
        images.push({
          id: `spacex_${launch.id}_${idx}`,
          source: 'SpaceX',
          title: launch.name || 'SpaceX Launch',
          description: `Rocket: ${rocket.name}. Mission Type: ${launch.mission_name || 'Unknown'}. Status: ${launch.success ? 'Success' : 'In Progress'}.`,
          image_url: url,
          date: launch.date_utc?.split('T')[0] || new Date().toISOString().split('T')[0],
          url: launch.links?.webcast || 'https://www.spacex.com'
        });
      });
    }

    if (images.length === 0 && launch.links?.webcast) {
      images.push({
        id: `spacex_${launch.id}`,
        source: 'SpaceX',
        title: launch.name || 'SpaceX Launch',
        description: `${rocket.name} launch. Mission: ${launch.mission_name || 'Unknown'}`,
        image_url: '',
        date: launch.date_utc?.split('T')[0] || new Date().toISOString().split('T')[0],
        url: launch.links.webcast
      });
    }

    return images;
  } catch(e) {
    console.warn('SpaceX fetch failed:', e);
    return [];
  }
}

async function fetchHubble() {
  try {
    const res = await fetch('https://images-api.nasa.gov/search?q=hubble&media_type=image&year_start=2024&page_size=10');
    if (!res.ok) throw new Error(`Hubble error: ${res.status}`);
    const data = await res.json();

    return (data.collection?.items || []).slice(0, 5).map(item => {
      const href = item.links?.[0]?.href || '';
      const data_obj = item.data?.[0] || {};
      return {
        id: `hubble_${data_obj.nasa_id || Math.random()}`,
        source: 'Hubble Space Telescope',
        title: data_obj.title || 'Hubble Image',
        description: data_obj.description || '',
        image_url: href,
        date: data_obj.date_created?.split('T')[0] || new Date().toISOString().split('T')[0],
        url: `https://images.nasa.gov/details-${data_obj.nasa_id}.html`
      };
    });
  } catch(e) {
    console.warn('Hubble fetch failed:', e);
    return [];
  }
}

async function fetchNOAA() {
  try {
    // NOAA Solar Dynamics Observatory recent images
    const res = await fetch('https://sdo.gsfc.nasa.gov/assets/img/latest/latest_1024_0193.jpg', { method: 'HEAD' });
    if (!res.ok) throw new Error(`NOAA error: ${res.status}`);

    return [{
      id: 'noaa_solar_' + Date.now(),
      source: 'NOAA / SDO',
      title: 'Solar Dynamics Observatory - Latest Image',
      description: 'Latest solar observation from NASA\'s Solar Dynamics Observatory (SDO).',
      image_url: 'https://sdo.gsfc.nasa.gov/assets/img/latest/latest_1024_0193.jpg',
      date: new Date().toISOString().split('T')[0],
      url: 'https://sdo.gsfc.nasa.gov/'
    }];
  } catch(e) {
    console.warn('NOAA fetch failed:', e);
    return [];
  }
}

async function fetchAll() {
  showError('');
  document.getElementById('feed-stream').innerHTML = '<div class="loader"><div class="spinner"></div><p style="color:var(--muted);font-size:0.85rem">Fetching latest images from all sourcesâ€¦</p></div>';

  try {
    const [apod, spacex, hubble, noaa] = await Promise.allSettled([
      fetchAPOD(),
      fetchSpaceX(),
      fetchHubble(),
      fetchNOAA(),
    ]);

    let images = [];
    if (apod.status === 'fulfilled') images.push(...apod.value);
    else console.warn('APOD failed:', apod.reason);

    if (spacex.status === 'fulfilled') images.push(...spacex.value);
    if (hubble.status === 'fulfilled') images.push(...hubble.value);
    if (noaa.status === 'fulfilled') images.push(...noaa.value);

    if (!images.length) throw new Error('No images fetched. Please try again later.');

    // Add category to each image
    images = images.map(img => {
      const category = categorize(img);
      return { ...img, category };
    });

    // Remove duplicates and sort by date (newest first)
    const uniqueIds = new Set();
    images = images.filter(img => {
      if (uniqueIds.has(img.id)) return false;
      uniqueIds.add(img.id);
      return true;
    }).sort((a, b) => {
      try {
        return new Date(b.date) - new Date(a.date);
      } catch {
        return 0;
      }
    });

    // Keep only last 100 images
    images = images.slice(0, 100);

    allImages = images;
    saveFeed(images);
    render(images);
  } catch(e) {
    showError(e.message || 'Failed to fetch images. Please try again.');
    console.error('Fetch error:', e);
    // Load cached images if available
    const cached = loadFeed();
    if (cached.length > 0) {
      allImages = cached;
      render(cached);
    }
  }
}

/* â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function render(images) {
  // Update stats
  const sources = [...new Set(images.map(i => i.source))];
  document.getElementById('stat-total').textContent = images.length;
  document.getElementById('stat-sources').textContent = sources.length;
  document.getElementById('stat-date').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

  // Update last-updated time
  updateTimestamps();

  // Render feed
  if (images.length === 0) {
    document.getElementById('feed-stream').innerHTML = '<div class="empty-state"><div class="icon">ğŸ”­</div><p>No images available. Try refreshing.</p></div>';
    return;
  }

  document.getElementById('feed-stream').innerHTML = images.map((img, i) => {
    const delay = (i * 0.05).toFixed(2);
    const truncDesc = (img.description || '').slice(0, 150);
    return `
      <div class="feed-card" style="--d:${delay}s" onclick="openModal(${i})">
        ${img.image_url
          ? `<img class="feed-image" src="${img.image_url}" alt="${escHtml(img.title)}" loading="lazy" onerror="this.style.display='none'">`
          : `<div class="feed-image-placeholder">ğŸ”­</div>`}
        <div class="feed-card-body">
          <div class="feed-card-meta">
            <span class="feed-source">${escHtml(img.source)}</span>
            <span class="feed-date">${img.date || 'â€”'}</span>
            <span class="feed-category">${img.category}</span>
          </div>
          <div class="feed-title">${escHtml(img.title)}</div>
          ${truncDesc ? `<div class="feed-description">${escHtml(truncDesc)}${img.description?.length > 150 ? 'â€¦' : ''}</div>` : ''}
          ${img.url ? `<a class="feed-link" href="${img.url}" target="_blank" onclick="event.stopPropagation()">View Source â†’</a>` : ''}
        </div>
      </div>`;
  }).join('');
}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function openModal(idx) {
  const img = allImages[idx];
  if (!img) return;

  document.getElementById('modal-body').innerHTML = `
    ${img.image_url ? `<img class="modal-img" src="${img.image_url}" alt="${escHtml(img.title)}" onerror="this.style.display='none'">` : ''}
    <div style="padding-top:${img.image_url ? '0' : '1.5rem'}">
      <button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">${escHtml(img.title)}</div>
      <div class="modal-meta">
        <span class="tag">${escHtml(img.source)}</span>
        <span class="tag">${img.category}</span>
        <span class="tag">${img.date || 'â€”'}</span>
      </div>
      <div class="modal-description">${escHtml(img.description || 'No description available.')}</div>
      ${img.url ? `<a class="modal-link" href="${img.url}" target="_blank">ğŸ”— View Source</a>` : ''}
    </div>`;

  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modal-overlay')) return;
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

/* â”€â”€ Timer & Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function updateTimestamps() {
  if (!lastFetchTime) {
    document.getElementById('last-updated').textContent = 'Never';
    document.getElementById('countdown').textContent = '1h 0m';
    return;
  }

  const now = new Date();
  const fetchDate = new Date(lastFetchTime);
  const diffMs = now - fetchDate;
  const diffMins = Math.floor(diffMs / 60000);

  if (diffMins < 1) {
    document.getElementById('last-updated').textContent = 'Just now';
  } else if (diffMins < 60) {
    document.getElementById('last-updated').textContent = `${diffMins}m ago`;
  } else {
    const diffHours = Math.floor(diffMins / 60);
    const remainingMins = diffMins % 60;
    document.getElementById('last-updated').textContent = `${diffHours}h ${remainingMins}m ago`;
  }

  // Countdown to next refresh (1 hour from fetch)
  const nextRefresh = new Date(fetchDate.getTime() + HOUR_MS);
  const countdownMs = nextRefresh - now;

  if (countdownMs <= 0) {
    document.getElementById('countdown').textContent = 'Now';
  } else {
    const countdownMins = Math.floor(countdownMs / 60000);
    const countdownHours = Math.floor(countdownMins / 60);
    const countdownRemaining = countdownMins % 60;
    document.getElementById('countdown').textContent = `${countdownHours}h ${countdownRemaining}m`;
  }
}

function startAutoRefresh() {
  // Update timestamps every minute
  setInterval(updateTimestamps, 60000);

  // Auto-refresh every hour
  refreshInterval = setInterval(() => {
    console.log('Auto-refreshing feed...');
    fetchAll();
  }, HOUR_MS);
}

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
function showError(msg) {
  document.getElementById('error-area').innerHTML = msg
    ? `<div class="error-box">âš ï¸ ${escHtml(msg)}</div>` : '';
}

function escHtml(str) {
  return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

/* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“ */
(async function init() {
  // Initialize live streams
  const streams = await initLiveStreams();
  renderLiveStreams(streams);

  // Load cached feed
  const cached = loadFeed();
  if (cached.length > 0) {
    allImages = cached;
    render(cached);
  }

  // Start auto-refresh timer
  startAutoRefresh();
})();
</script>
</body>
</html>
